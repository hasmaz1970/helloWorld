#############################################################################
## 1. OPENAPI
#############################################################################
openapi: 3.0.2

#############################################################################
## 2. INFO
#############################################################################
info:
  version: 1.0.0
  title: Common Billing Schema (Data Type) Definitions
  contact:
    name: MonE Product Development
    
  license:
    name: GNU AGPLv3
    url: https://www.gnu.org/licenses/agpl-3.0.en.html
  description: |
    <!-- Note that this description is a MARKDOWN Block -->

    **This Open API specification does NOT contain any valid PATHS/OPERATIONS!!!. It ONLY contains COMMON SCHEMA (TYPE) DEFINITIONS referred by other API specifications.**

    Thus, in this context COMMON SCHEMA (TYPE) DEFINITIONS mean shared entity data models or baseline objects that can be reused with or without extension.

#############################################################################
## 3. SERVERS
#############################################################################

servers:
  - url: https://{environment}.monetizehub.io:{port}/private/COMMON_TYPE_DEFINITION
    description: The production API server
    variables:
      environment:
        enum:
          - 'dev'
          - 'test'
          - 'staging'
          - ''
        default: 'dev'
      port:
        enum:
          - '443'
          - '8443'
        default: '443'
      version:
        default: 'v1'

#############################################################################
## 4. PATHS
#############################################################################
paths:
  /readMe:
    get:
      summary: This is a placeholder nouse operation. (to bypass Swagger UI limitation of a specification with ONLY data models without operation)
      operationId: readMe
      responses:
        default:
          description: default response
          content:
            '*/*':
              schema:
                type: string


#############################################################################
## 5. COMPONENTS
#############################################################################
components:


#############################################################################
## 5.x. SECURITY SCHEMES
#############################################################################
  securitySchemes:
    JWT_Bearer:
      type: http
      scheme: bearer 
      bearerFormat: JWT
    IAM_OAuth:
      type: oauth2
      description: |
        **OAuth Grant Type: Password Credentials**
      flows:
        password:
          tokenUrl: https://iam.monetizehub.io/oauth/v1/token
          scopes:
            write:resources: modify resources
            read:resources: read resources
    



#############################################################################
## 5.x. RESPONSES
#############################################################################




#############################################################################
## 5.x. SCHEMA DEFINITIONS
#############################################################################

  schemas:



#############################################################################
#############################################################################
## BillingMonetizationTemplate
#############################################################################
#############################################################################


    BillingMonetizationTemplate:
      description:
        Billing MonetizationTemplate.
      allOf:
        - $ref: "#/components/schemas/VersionedEntityRef"
        - type: object
          required:
            - billLineItemAggregationRule
          properties:
            billLineItemAggregationRuleSet:
              description: |
                Bill Line Item Aggregation Rule
              $ref: "#/components/schemas/VersionedEntityRef"
            billTaxCategoryItemAggregationRuleSet:
              description: |
                Bill Tax Category Item Aggregation Rule
              $ref: "#/components/schemas/VersionedEntityRef"
            billGlcodeItemAggregationRule:
              description: |
                Bill Glcode Item Aggregation Rules 
              $ref: "#/components/schemas/VersionedEntityRef"
            billCostAllocationItemAggregationRuleSet:
              description: |
                Bill Cost Allocation Item Aggregation Rules
              $ref: "#/components/schemas/VersionedEntityRef"

    BillingMonetizationTemplateRef:
      description: 
        Reference. BillingMonetizationTemplate.

      allOf:
        - $ref: "#/components/schemas/VersionedEntityRef"

#############################################################################
## HOTBILL DATA MODELs
#############################################################################

    Event_Billing_Hotbill_MTMF_Input:
      description: |
        Input Event to register Hotbill Request to EMSP (Event Message Streaming Platform).<br>
        Event Type for HB_MTMF Input


      allOf:
        - $ref: "#/components/schemas/Event"
        - type: object
          properties:
            payload: 
              $ref: "#/components/schemas/BDS_Base"


    Event_Hotbill:
      description: |
        Generic Event Type for Input/Output of all Hotbill Modules, except for HB_MTMF  Input

      allOf:
        - $ref: "#/components/schemas/Event"
        - type: object
          properties:
            payload: 
              type: array
              items:
                $ref: "#/components/schemas/BDS"


#############################################################################
## Billing Events (DOES NOT INCLUDE NOTIFICATIONs)

    BDS_Base:
      description: 
        MonE HotBilling Data Stream Request
      allOf:
        - $ref: "#/components/schemas/EntityRef"
        - type: object
          properties:
            chargingEventStreamRef:
              description: |
                Used to assign the correct mapper/converter to the stream prior to charging          
              $ref: "#/components/schemas/RelatedEntityRef"
            qualifierCollection:
              $ref: "#/components/schemas/Collection"
            quantifierCollection:
              $ref: "#/components/schemas/Collection"
            qualifierMap:
              $ref: '#/components/schemas/Any'
            quantifierMap:
              $ref: '#/components/schemas/Any'
            chargePart:
              type: array
              items:
                $ref: "#/components/schemas/ChargePartItem"


    BDS_MonE_Template:
      description: 
        MonE BDS-Billing Data Stream with Monetization Template (MonE Template applied)

      allOf:
        - $ref: "#/components/schemas/Entity"  
        - type: object    
          properties:
            billingEventStreamRef:
              $ref: "#/components/schemas/RelatedEntityRef"
            qualifierCollection:
              $ref: "#/components/schemas/Collection"
            quantifierCollection:
              $ref: "#/components/schemas/Collection"
            qualifierMap:
              $ref: '#/components/schemas/Any'
            quantifierMap:
              $ref: '#/components/schemas/Any'
            chargePart:
              type: array
              items:
                $ref: "#/components/schemas/ChargePartItem"
            monetizationTemplate:
              $ref: "#/components/schemas/BillingMonetizationTemplate"
            appliedAggregation:
              $ref: '#/components/schemas/AppliedAggregation'




    BDS:
      description: 
        MonE BDS-Billing Data Stream with Monetization Template (MonE Template applied)

      allOf:
        - $ref: "#/components/schemas/Entity"  
        - type: object    
          properties:
            billingEventStreamRef:
              $ref: "#/components/schemas/RelatedEntityRef"
            qualifierCollection:
              $ref: "#/components/schemas/Collection"
            quantifierCollection:
              $ref: "#/components/schemas/Collection"
            qualifierMap:
              $ref: '#/components/schemas/Any'
            quantifierMap:
              $ref: '#/components/schemas/Any'
            chargePart:
              $ref: "#/components/schemas/ChargePartItem"
            monetizationTemplate:
              $ref: "#/components/schemas/BillingMonetizationTemplate"
            appliedAggregation:
              $ref: '#/components/schemas/AppliedAggregation'
            appliedCustomerBillLineItem:
              type: array
              items:
                $ref: "#/components/schemas/AppliedCustomerBillLineItem"
            appliedCustomerBillTaxLineItem:
              type: array
              items:
                $ref: "#/components/schemas/AppliedCustomerBillTaxLineItem"
            appliedCustomerBillGlcodeLineItem:
              type: array
              items:
                $ref: "#/components/schemas/AppliedCustomerBillGlcodeLineItem"
            appliedCustomerBillCostAllocationLineItem:
              type: array
              items:
                $ref: "#/components/schemas/AppliedCustomerBillCostAllocationLineItem"


    Hotbill_ABMDS:
      description: 
        MonE Hotbill-ABMDS-Account Balance Management Data Stream (Persist Balance Delta Updates on DB)

      allOf:
        - $ref: "#/components/schemas/Entity"  
        - type: object    
          properties:
            TODO:
              type: string
              example: "TODO"



#############################################################################
## BILL AGGREGATION RULES internal BDS Stream Type Definitions
#############################################################################

    AppliedAggregation:
      description: |
        Applied aggregations per charge item as per Billing Monetization Template
      type: object
      properties:
        appliedBillLineItemAggregation:
          type: array
          items:
            $ref: '#/components/schemas/AppliedBillLineItemAggregationItem'
        appliedBillTaxCategoryAggregation:
          type: array
          items:
            $ref: '#/components/schemas/AppliedBillTaxCategoryAggregationItem'
        appliedBillGlcodeAggregation:
          type: array
          items:
            $ref: '#/components/schemas/AppliedBillGlcodeAggregationItem'
        appliedBillCostAllocationAggregation:
          type: array
          items:
            $ref: '#/components/schemas/AppliedBillCostAllocationAggregationItem'
            

    AppliedBillLineItemAggregationItem:
      description: 
        Bill LineItem aggregationCode to be used for each chargePart
      type: object
      properties:
        chargePartIndex:
          type: integer
          minimum: 0
        ruleBranchPath:
          type: string
        ruleResult:
          type: array
          items:
            $ref: '#/components/schemas/BillLineItemAggregationKey'
        aggregationKeyValue:
          description: Concatenated values of BillLineItemAggregationKey set items
          type: string
        lineItemName:
          description: aggregationKeyValue mapped to lineItemName
          type: string

    BillLineItemAggregationKey:
      description: BillLineItemAggregationKey
      type: object
      properties:
        propertyAccessType:
          type: string
          enum:
            - collection
            - object
        collectionPropertyKey:
          $ref: "#/components/schemas/CollectionPropertyKey"
        objectPropertyKey:
          $ref: "#/components/schemas/ObjectPropertyKey"


    AppliedBillTaxCategoryAggregationItem:
      description: 
        Bill TaxCategory aggregationCode to be used for each chargePart
      type: object
      properties:
        chargePartIndex:
          type: integer
          minimum: 0
        ruleBranchPath:
          type: string
        ruleResult:
          type: array
          items:
            $ref: '#/components/schemas/TaxItem'

    AppliedBillGlcodeAggregationItem:
      description: 
        Bill Glcode aggregationCode to be used for each chargePart
      type: object
      properties:
        chargePartIndex:
          type: integer
          minimum: 0
        ruleBranchPath:
          type: string
        ruleResult:
          type: array
          items:
            $ref: '#/components/schemas/GlcodeItem'

    GlcodeItem:
      description: |
        Used to describe Glcode Item
      allOf:
        - $ref: "#/components/schemas/Entity"
        - type: object
          properties:
            glcodeCategory:
              description: "Glcode category"
              type: string
            glcode:
              description: "Glcode"
              type: string

    AppliedBillCostAllocationAggregationItem:
      description: 
        Bill CostAllocation aggregationCode to be used for each chargePart
      type: object
      properties:
        chargePartIndex:
          type: integer
          minimum: 0
        ruleBranchPath:
          type: string
        ruleResult:
          type: array
          items:
            $ref: '#/components/schemas/CostAllocationItem'

    CostAllocationItem:
      description: |
        Used to describe CostAllocationItem Item
      allOf:
        - $ref: "#/components/schemas/Entity"
        - type: object
          properties:
            costAllocationCategory:
              description: "CostAllocationItem category"
              type: string
            costAllocationCode:
              description: "Cost Allocation Code"
              type: string




#############################################################################
## BILL PUBLIC API DATA MODELs
#############################################################################
    AbstractCustomerBillItem:
      description: |
        Abstract Customer BillItem.
      allOf:
        - $ref: "#/components/schemas/EntityRef"
        - type: object
          required:
            - date
            - isBilled
            - billingAccount
            - bill
          properties:
            billNo:
              description: "Bill reference known by the customer or the party and displayed on the bill. Could be different from the id."
              type: string
            description:
              description: "Additional data to be displayed on the bill for this customer applied billing rate"
              type: string
            date:
              description: "Creation date of the applied billing rate"
              type: string
              format: date-time
            periodCoverage:
              description: "periodCoverage for RecurringCharge (RC)"
              $ref: '#/components/schemas/TimePeriod'
            isBilled:
              description: |
                If isBilled, THEN in referenced bill, billNo (invoice no) is available.
              type: boolean
            bill:
              $ref: '#/components/schemas/BillRef'
            billingAccount:
              $ref: '#/components/schemas/BillingAccountRef'
            appliedTax:
              type: array
              items:
                $ref: '#/components/schemas/AppliedBillingTaxRate'
            characteristic:
              type: array
              items:
                $ref: '#/components/schemas/AppliedBillingRateCharacteristic'


    AppliedCustomerBillLineItem:
      description: |
        Applied Bill Line Items related to a Bill or Account.
        Utilizes TMFORUM: AppliedCustomerBillingRate
        For each Bill Line Item, a list of applied Tax Items that constitute each Bill Line Item item is provided.
      allOf:
        - $ref: "#/components/schemas/AbstractCustomerBillItem"
        - type: object
          required:
            - date
            - isBilled
            - billingAccount
            - bill
            - lineItemName
            - taxExcludedAmount
          properties:
            lineItemName:
              type: string
              description: "AggregationLine Item Name determined via Billing Monetization Template"
            taxExcludedAmount:
              $ref: "#/components/schemas/Money"
            taxIncludedAmount:
              $ref: "#/components/schemas/Money"
##MonE added
            paidAmount:
              description: "Amount paid for this bill item expressed in the given currency"
              $ref: '#/components/schemas/Money'
            appliedPayment:
              type: array
              items:
                $ref: '#/components/schemas/AppliedPayment'
            billingDiscountPart:
              type: array
              items:
                $ref: "#/components/schemas/BillLineDiscountItem"



    BillLineDiscountItem:
      description: 
        MonE DiscountPart within BDS-Billing Data Stream
      allOf:
        - $ref: "#/components/schemas/Entity"        
        - type: object
          properties:
            to_be_defined:
              type: string

    AppliedCustomerBillTaxLineItem:
      description: |
        Applied Bill Tax Category Items related to a Bill or Account.
        For each Tax Category Item, a list of applied Tax Items that constitute each Bill Tax Category item is provided.
      allOf:
        - $ref: "#/components/schemas/AbstractCustomerBillItem"
        - type: object
          required:
            - date
            - isBilled
            - billingAccount
            - bill
            - appliedTax


    AppliedCustomerBillGlcodeLineItem:
      description: |
        Applied Bill Glcode Items related to a Bill or Account.
        For each Glcode Item, a list of applied Tax Items that constitute each Glcode Item is provided.
      allOf:
        - $ref: "#/components/schemas/AbstractCustomerBillItem"
        - type: object
          required:
            - date
            - isBilled
            - billingAccount
            - bill
            - glcode
            - taxExcludedAmount
          properties:
            taxExcludedAmount:
              $ref: "#/components/schemas/Money"
            taxIncludedAmount:
              $ref: "#/components/schemas/Money"
            glcodeCategory:
              description: "Applied Glcode Category"
              type: string
            glcode:
              description: "Applied Glcode"
              type: string


    AppliedCustomerBillCostAllocationLineItem:
      description: |
        Applied Bill Cost Allocation Code Items related to a Bill or Account.
        For each Cost Allocation Code, a list of applied Tax Items that constitute each Cost Allocation Code Item is provided.
      allOf:
        - $ref: "#/components/schemas/AbstractCustomerBillItem"
        - type: object
          required:
            - date
            - isBilled
            - billingAccount
            - bill
            - lineItemName
            - costAllocationCode
          properties:
            lineItemName:
              type: string
              description: "AggregationLine Item Name determined via Billing Monetization Template"
            costAllocationCode:
              description: "Applied Cost Allocation Code"
              type: string




        

#############################################################################
## 5.x. EXTERNAL COMMON DATA TYPE REFERENCES
#############################################################################

    ChargePartItem:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_charging_type_schemas.yaml#/components/schemas/ChargePartItem'
    RatedProductTransactionType:
      $ref: "/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_charging_type_schemas.yaml#/components/schemas/RatedProductTransactionType"

    Entity:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/Entity'
    EntityRef:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/EntityRef'
    RelatedEntityRef:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/RelatedEntityRef'
    Characteristic:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/Characteristic'
    Price:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/Price'    
    Quantity:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/Quantity' 
    Any:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/Any'    
    TaxItem:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/TaxItem'            
    TimePeriod:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/TimePeriod'
    Money:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/Money'
    AppliedPayment:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/AppliedPayment'

    BillRef:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/BillRef'
    BillingAccountRef:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/BillingAccountRef'
    AppliedBillingTaxRate:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/AppliedBillingTaxRate'


    AppliedBillingRateCharacteristic:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_tmforum_openapi_schemas.yaml#/components/schemas/AppliedBillingRateCharacteristic'

    RelatedEntityRefWithRole:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/RelatedEntityRefWithRole'
    AppliedCustomerBillingRateItemType:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/AppliedCustomerBillingRateItemType'    

    CollectionPropertyKey:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/CollectionPropertyKey'   
    ObjectPropertyKey:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/ObjectPropertyKey'   

    VersionedEntity:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/VersionedEntity'
    VersionedEntityRef:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/VersionedEntityRef'
    VersionedRelatedEntityRef:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/VersionedRelatedEntityRef'

    DecisionTree:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/DecisionTree'
    DecisionTreeRef:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/DecisionTreeRef'

    Event:
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/Event'
    Collection:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/Collection'

    CollectionItem:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/CollectionItem'
    CollectionItemKey:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/CollectionItemKey'   

    AccountRelationType:  
      $ref: '/INTERFACES/API-SPECIFICATION/YAML/PRIVATE/common_private_type_schemas.yaml#/components/schemas/AccountRelationType'   

#############################################################################
## 5.x. EXTERNAL COMMON API TYPE REFERENCES
#############################################################################



#############################################################################
## 6. SECURITY
#############################################################################
security:
  - JWT_Bearer: []
  - IAM_OAuth: []                    

#############################################################################
## 7. TAGS
#############################################################################


#############################################################################
## 8. EXTERNAL DOCS
#############################################################################
externalDocs:
  description:
    Find more information here.
  url: https://monetizehub.io/docs/home/






#############################################################################
#############################################################################